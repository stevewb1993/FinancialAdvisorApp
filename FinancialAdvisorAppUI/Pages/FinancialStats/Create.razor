@page "/financialstats/create/"
@inject NavigationManager _navManager
@inject IFinancialStatRepository _financialStatRepo
@inject IFinanceTypeRepository _financeTypeRepo
@inject HttpClient _client
@inject ApiAuthenticationStateProvider _authentication
@inject IToastService _toastService

<h3 class="card-title">Create a record of your financial stats</h3>
<p>You don't need to add an entry for every stat type, but the more information you provide, the more targetted your goals will be.</p>

<br />


@if (!isDateSelected)
{
    <EditForm Model="financeDateModel" OnValidSubmit="ConfirmDate">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="form-group">
            <label for="FinanceDate">As of date</label>
            <InputDate @bind-Value="financeDateModel.financeDate" class="form-control" id="FinanceDate" />
        </div>
        <button class="btn btn-primary" type="submit">
            <span class="oi oi-pencil"></span>
            Confirm Date
        </button>
    </EditForm>
}
else
{


    for (int i = 0; i < 10; i++)
    {
        <p>@financialStatModelList[i].FinanceType.FinanceDesc</p>


        <EditForm Model="financialStatModelList[i]" OnValidSubmit="returnVoid">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <h5>Value of @financialStatModelList[i].FinanceType.FinanceDesc</h5>
            <div class="form-group">
                <label for="FinanceValue">Value</label>
                <InputDate @bind-Value="financialStatModelList[i].FinanceValue" class="form-control" id="FinanceValue" />
            </div>
            <button class="btn btn-primary" type="submit">
                <span class="oi oi-pencil"></span>
                Update Details
            </button>
        </EditForm>


    }

    @*<h6>@financeDateModel.financeDate.ToString("dd MMMM yyyy")</h6>
    <br />
    for (int i = 0; i < 11; i++)
    {
        Console.WriteLine(i);
        Console.WriteLine(financialStatModelList[i].FinanceType.FinanceDesc);
        try
        {
            <EditForm Model="financialStatModelList[i]" OnValidSubmit="returnVoid">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <h5>Value of @financialStatModelList[i].FinanceType.FinanceDesc</h5>
                <div class="form-group">
                    <label for="FinanceValue">Value</label>
                    <InputNumber @bind-Value="financialStatModelList[i].FinanceValue" class="form-control" id="FinanceValue" />
                </div>
                <button class="btn btn-primary" type="submit" @onclick="() => CreateFinancialStat(financialStatModelList[i].FinanceValue, financialStatModelList[i].FinanceTypeId)">
                    <span class="oi oi-pencil"></span>
                    Update Details
                </button>
            </EditForm>
            <br />
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }

    }*@
}


@code
{

    private FinanceDate financeDateModel = new FinanceDate();
    private string userId;
    private List<FinanceType> financeTypes = new List<FinanceType>();
    private List<FinancialStat> financialStatModelList = new List<FinancialStat>();

    private bool isExistsFinancialStats;

    private bool isDateSelected = false;

    private List<FinancialStat> userFinancialStats = new List<FinancialStat>();


    protected async override Task OnInitializedAsync()
    {

        var auth = await _authentication.GetAuthenticationStateAsync();
        userId = auth.User.FindFirst(AppConstants.UserId).Value;

        financeTypes = await _financeTypeRepo.Get(Endpoints.FinanceTypesEndpoint) as List<FinanceType>;



        isExistsFinancialStats = await _financialStatRepo.CheckUserHasRecords(Endpoints.FinancialStatsEndpoint, userId);

        if (isExistsFinancialStats)
        {
            userFinancialStats = await _financialStatRepo.GetByUserId(Endpoints.FinancialStatsEndpoint, userId) as List<FinancialStat>;
        }
    }


    private async void CreateFinancialStat(decimal financeValue, string financeTypeId)
    {
        bool isSuccess = false;
        bool isExistsPreviousRecord = false;

        FinancialStat financialStatToSubmit;

        if (isExistsFinancialStats)
        {
            var previousRecords = userFinancialStats.Where(x => x.FinanceDate == financeDateModel.financeDate & x.FinanceTypeId == financeTypeId).ToList();
            isExistsPreviousRecord = previousRecords.Count > 0;
            if (isExistsPreviousRecord) //record already exists. take existing request and submit put request
            {
                string existingGuid = previousRecords.First().Id;
                financialStatToSubmit = new FinancialStat(financeDateModel.financeDate, financeTypeId, financeValue, userId, existingGuid);
                isSuccess = await _financialStatRepo.Update(Endpoints.FinancialStatsEndpoint, financialStatToSubmit, existingGuid);
                userFinancialStats.Remove(previousRecords.First());
                userFinancialStats.Add(financialStatToSubmit);
            }
        }
        if (!isExistsPreviousRecord) //no previous entry, create new guid and submit post request
        {
            Guid newRecordGuid = Guid.NewGuid();
            financialStatToSubmit = new FinancialStat(financeDateModel.financeDate, financeTypeId, financeValue, userId, newRecordGuid.ToString());
            isSuccess = await _financialStatRepo.Create(Endpoints.FinancialStatsEndpoint, financialStatToSubmit);
            userFinancialStats.Add(financialStatToSubmit);
            isExistsFinancialStats = true;
        }


        if (isSuccess) _toastService.ShowSuccess("Details submitted successfully", "");
        else _toastService.ShowError("Something went wrong");

    }



    private async void returnVoid()
    {

    }


    private async void ConfirmDate()
    {
        //if(financeTypes.Count < 10) Thread.sleep
        Console.WriteLine("creating models");
        foreach (FinanceType financeType in financeTypes)
        {

            financialStatModelList.Add(new FinancialStat(financeDateModel.financeDate, financeType.Id, financeType));
            Console.WriteLine(financeType.FinanceDesc);

        }
        Console.WriteLine("completed creating models");
        isDateSelected = true;
    }

    public class FinanceDate
    {
        public DateTime financeDate { get; set; }
    }


    public class FinanceStatsFullModel
    {
        public List<FinancialStat>;
    }

}
